# GitHub Actions â€“ Deploy to Google Cloud Run (ç°¡åŒ–ç‰ˆ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# jobs:
# cloud_build     â†’ èª¿ç”¨ Google Cloud Build é€²è¡Œæ‰€æœ‰å·¥ä½œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Deploy to Google Cloud Run

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ (production/staging)'
        required: true
        default: 'staging'
        type: choice
        options: [production, staging]

# ---------- Re-usable environment block ----------
env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION || 'asia-east1' }}

# æ˜ç¢ºè¨­ç½®é è¨­æ¬Šé™
permissions:
  contents: read

jobs:
  # =============================================================
  # Cloud Build Job - å–®ä¸€ Job å–ä»£èˆŠçš„ 4-Job pipeline
  # =============================================================
  cloud_build:
    name: ğŸš€ Cloud Build & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      # --- Checkout ---------------------------------------------------------
      - uses: actions/checkout@v4

      # --- Decide env / tags -----------------------------------------------
      - id: vars
        name: ğŸ› ï¸ Calc variables
        shell: bash
        run: |
          set -e
          ENVIRONMENT="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}"
          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          echo "_ENV=$ENVIRONMENT" >> $GITHUB_ENV

          if [[ "$ENVIRONMENT" == "production" ]]; then
            echo "_MAX_INSTANCES=2" >> $GITHUB_ENV
          else
            echo "_MAX_INSTANCES=1" >> $GITHUB_ENV
          fi

      # --- Auth -------------------------------------------------------------
      - name: ğŸ”‘ Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # --- èª¿ç”¨ Cloud Build --------------------------------------------------
      - name: ğŸ—ï¸ Cloud Build
        id: build
        shell: bash
        run: |
          set -e
          # å…ˆè¨­ç½®ç’°å¢ƒè®Šæ•¸ï¼Œè®“å¾ŒçºŒå¯ä»¥ç›´æ¥ç”¨ Bash è®Šæ•¸
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "_ENV=production" >> $GITHUB_ENV
          else
            echo "_ENV=staging" >> $GITHUB_ENV
          fi

          # è¨­ç½® REGION (é¿å…é‡è¤‡ä½¿ç”¨ ${{ env.XXX }})
          echo "REGION=${{ vars.GCP_REGION || 'asia-east1' }}" >> $GITHUB_ENV

          # æ·»åŠ åŸ·è¡Œéšæ®µéœ€è¦çš„è®Šæ•¸
          if [ "${{ env._ENV }}" = "production" ]; then
            echo "_MAX_INSTANCES=2" >> $GITHUB_ENV
          else
            echo "_MAX_INSTANCES=1" >> $GITHUB_ENV
          fi

          # ç­‰å¾…è®Šæ•¸è¨­ç½®ç”Ÿæ•ˆ
          sleep 1

          # æ ¹æ“šç’°å¢ƒè¨­ç½®å¾Œç¶´ï¼ˆç›´æ¥ä½¿ç”¨ Bash è®Šæ•¸ï¼Œé¿å…ä½¿ç”¨ ${} æ ¼å¼ï¼‰
          if [ "$_ENV" = "production" ]; then
            suffix=""
          else
            suffix="-dev"
          fi

          # æ‰‹å‹•æ§‹å»ºå®Œæ•´æ˜ åƒè·¯å¾‘ï¼ˆä½¿ç”¨ç´” Bash è®Šæ•¸ï¼Œé¿å…ä½¿ç”¨ ${} æ ¼å¼ï¼‰
          FULL_IMAGE_PATH="$REGION-docker.pkg.dev/${{ env.PROJECT_ID }}/one-key-balance-kit/api$suffix"

          # èª¿ç”¨ Cloud Buildï¼ˆä½¿ç”¨ç´” Bash è®Šæ•¸ï¼‰
          # ç¢ºä¿ä½¿ç”¨å¼•è™ŸåŒ…è£¹æ•´å€‹ substitutions å­—ç¬¦ä¸²
          gcloud builds submit \
            --project=${{ env.PROJECT_ID }} \
            --config=cloudbuild.yaml \
            --substitutions="_IMAGE_PATH=$FULL_IMAGE_PATH,_ENV=$_ENV,_MAX_INSTANCES=$_MAX_INSTANCES,_REGION=$REGION,_GIT_SHA=${{ github.sha }}"

      # --- é¡¯ç¤ºéƒ¨ç½² URL -----------------------------------------------------
      - name: ğŸŒ Show Service URL
        if: ${{ success() && !cancelled() }}
        shell: bash
        run: |
          ENV_SUFFIX=$([ "${{ env._ENV }}" = "production" ] && echo "" || echo "-dev")
          SERVICE_NAME="one-key-balance-kit$ENV_SUFFIX"

          URL=$(gcloud run services describe $SERVICE_NAME \
                --region=${{ env.REGION }} \
                --project=${{ env.PROJECT_ID }} \
                --format="value(status.url)")

          echo "âœ… ${{ env._ENV }} ç’°å¢ƒéƒ¨ç½²å®Œæˆ"
          echo "ğŸ”— æœå‹™ URL: $URL"
