---
description: 區塊鏈服務模組
globs:
alwaysApply: false
---
# 區塊鏈服務模組

本專案實現了一個模組化的區塊鏈服務架構，通過統一介面支援多種區塊鏈。`src/chains` 目錄包含核心業務邏輯和區塊鏈操作模組。

## 架構概述

系統使用混合架構設計，結合了工廠模式、裝飾器自動註冊和代理模式：

1. **統一介面**：所有鏈服務實現 [ChainService](mdc:src/chains/interfaces/chain-service.interface.ts) 介面
2. **餘額功能擴展**：支援餘額查詢的鏈服務額外實現 [BalanceQueryable](mdc:src/chains/interfaces/balance-queryable.interface.ts) 介面
3. **抽象基類**：[AbstractChainService](mdc:src/chains/services/core/abstract-chain.service.ts) 提供通用實現
4. **工廠模式**：[ChainServiceFactory](mdc:src/chains/services/core/chain-service.factory.ts) 管理服務實例
5. **裝飾器註冊**：使用 [@Chain](mdc:src/chains/decorators/chain.decorator.ts) 裝飾器自動發現和註冊服務
6. **攔截器機制**：使用 [BlockchainProviderInterceptor](mdc:src/chains/interceptors/blockchain-provider.interceptor.ts) 處理提供者選擇
7. **請求級提供者**：使用 [UseBlockchainProvider](mdc:src/chains/decorators/blockchain-provider.decorator.ts) 裝飾器設定提供者
8. **錯誤處理**：使用 [ErrorCode](mdc:src/common/constants/error-codes.ts) 和自定義異常提供統一錯誤處理

## 目錄結構

```
src/chains/
├── interfaces/                     # 介面定義
│   ├── chain-service.interface.ts  # 鏈服務介面
│   └── balance-queryable.interface.ts # 餘額服務介面
├── decorators/                     # 裝飾器定義
│   ├── chain.decorator.ts          # 鏈服務裝飾器
│   └── blockchain-provider.decorator.ts # 提供者裝飾器
├── interceptors/                   # 攔截器
│   └── blockchain-provider.interceptor.ts # 提供者攔截器
├── services/                       # 服務實現
│   ├── core/                       # 核心服務
│   │   ├── abstract-chain.service.ts # 抽象鏈服務基類
│   │   ├── chain-service.factory.ts  # 鏈服務工廠
│   │   ├── discovery.service.ts      # 裝飾器發現服務
│   │   ├── blockchain.service.ts     # 區塊鏈服務
│   │   └── request-context.service.ts # 請求上下文服務
│   ├── ethereum/                   # 以太坊服務
│   │   └── ethereum.service.ts
│   └── solana/                     # Solana 服務
│       └── solana.service.ts
├── controllers/                    # 控制器
│   └── chains.controller.ts        # 鏈服務 API 控制器
├── constants/                      # 常量定義
│   └── index.ts                    # 鏈相關常量
├── chains.module.ts                # 區塊鏈模組
└── index.ts                        # 入口檔案
```

## 支援的區塊鏈

目前支援的區塊鏈包括：

- **以太坊** (ETH)：完整支援地址驗證、交易查詢、餘額查詢
- **Solana** (SOL)：完整支援地址驗證、交易查詢、餘額查詢

## 使用方法

### 1. 引入模組

```typescript
import { Module } from '@nestjs/common';
import { ChainsModule } from './chains/chains.module';

@Module({
  imports: [ChainsModule],
})
export class AppModule {}
```

### 2. 使用區塊鏈服務

有兩種方式使用鏈服務：

#### a. 直接注入工廠服務：

```typescript
import { Injectable } from '@nestjs/common';
import { ChainServiceFactory } from './chains/services/core/chain-service.factory';
import { ChainName } from './chains/constants';

@Injectable()
export class YourService {
  constructor(private readonly chainServiceFactory: ChainServiceFactory) {}

  async someMethod() {
    // 使用鏈名稱
    const ethService = this.chainServiceFactory.getChainService(ChainName.ETHEREUM);

    // 也可使用代幣符號（不區分大小寫）
    const solService = this.chainServiceFactory.getChainService('sol');

    // 使用服務方法
    const isValid = ethService.isValidAddress('0x...');
  }
}
```

#### b. 使用 BlockchainService（推薦）：

```typescript
import { Injectable } from '@nestjs/common';
import { BlockchainService } from './chains/services/core/blockchain.service';

@Injectable()
export class YourService {
  constructor(private readonly blockchainService: BlockchainService) {}

  async someMethod() {
    // 獲取特定鏈的服務 - 會自動使用請求上下文中的提供者
    const ethereumService = this.blockchainService.getService('ethereum');

    // 使用服務方法
    const isValid = ethereumService.isValidAddress('0x...');
    const balance = await ethereumService.getBalances('0x...');
  }
}
```

### 3. 指定區塊鏈提供者

使用 `@UseBlockchainProvider()` 裝飾器可以指定區塊鏈提供者：

```typescript
import { Controller, Get, Param } from '@nestjs/common';
import { UseBlockchainProvider } from './chains/decorators/blockchain-provider.decorator';

@Controller('balances')
@UseBlockchainProvider('alchemy') // 控制器級別設置
export class BalanceController {
  constructor(private readonly balanceService: BalanceService) {}

  @Get(':chain/:address')
  @UseBlockchainProvider('quicknode') // 方法級別設置（優先）
  getBalances(@Param('chain') chain: string, @Param('address') address: string) {
    return this.balanceService.getPortfolio(chain, address);
  }
}
```

客戶端也可以通過查詢參數指定提供者：
```
GET /balances/ethereum/0x742d35Cc6634C0532925a3b844Bc454e4438f44e?provider=quicknode
```

## 餘額查詢 API

`BalanceQueryable` 介面提供了獲取區塊鏈地址餘額的能力：

```typescript
export interface BalanceQueryable {
  /**
   * 獲取特定地址的餘額資訊
   * @param address 區塊鏈地址
   * @param useTestnet 是否使用測試網絡，默認為 false
   * @param providerType 可選的提供者類型
   * @returns 包含餘額信息的對象
   */
  getBalances(address: string, useTestnet?: boolean, providerType?: string): Promise<BalanceResponse>;
}
```

所有餘額查詢返回統一的 `BalanceResponse` 格式，包含原生代幣、代幣和 NFT 資訊。

## 錯誤處理

系統使用統一的錯誤處理機制：

1. **錯誤代碼**：使用 `ErrorCode` 枚舉定義不同類型的錯誤
2. **自定義異常**：使用 `BlockchainException`, `BalanceException` 等自定義異常類
3. **統一格式**：HTTP 響應以統一格式返回錯誤信息

例如，處理無效地址：

```typescript
if (!chainService.isValidAddress(address)) {
  throw new BlockchainException(
    ErrorCode.BLOCKCHAIN_INVALID_ADDRESS,
    `Invalid ${chain} address: ${address}`,
  );
}
```

## API 端點

鏈服務模組提供了以下 API 端點：

- `GET /chains`: 獲取所有支持的鏈類型
- `GET /chains/:chain/validate/:address`: 驗證地址是否有效
- `GET /chains/:chain/transactions/:address`: 獲取地址的交易歷史
- `GET /balances/:chain/:address`: 獲取地址的餘額資訊

## 擴展新區塊鏈

添加新的區塊鏈支援需要：

1. 更新 [constants/index.ts](mdc:src/chains/constants/index.ts) 中的 `ChainName` 枚舉
2. 創建繼承 `AbstractChainService` 的服務類並使用 `@Chain()` 裝飾器
3. 可選：實現 `BalanceQueryable` 介面提供餘額查詢功能
4. 確保新的鏈服務被 NestJS 的依賴注入系統管理（添加到適當的模組中）

### 添加新的鏈服務示例

```typescript
import { Injectable } from '@nestjs/common';
import { AbstractChainService } from './chains/services/core/abstract-chain.service';
import { Chain } from './chains/decorators/chain.decorator';
import { ChainName } from './chains/constants';
import { BalanceQueryable, BalanceResponse } from './chains/interfaces/balance-queryable.interface';
import { ConfigService } from '@nestjs/config';

@Injectable()
@Chain(ChainName.YOUR_CHAIN)
export class YourChainService extends AbstractChainService implements BalanceQueryable {
  constructor(protected readonly configService: ConfigService) {
    super();
    // 從配置中獲取默認提供者
    const defaultProvider = this.configService.get<string>('blockchain.defaultProvider', 'alchemy');
    this.setDefaultProvider(defaultProvider);
  }

  getChainName(): string {
    return ChainName.YOUR_CHAIN;
  }

  getChainSymbol(): string {
    return 'YCN';
  }

  isValidAddress(address: string): boolean {
    // 實現驗證邏輯
    return true;
  }

  async getAddressTransactionHashes(address: string): Promise<string[]> {
    // 實現獲取交易哈希的邏輯
    return ['hash1', 'hash2'];
  }

  async getTransactionDetails(hash: string): Promise<any> {
    // 實現獲取交易詳情的邏輯
    return { hash, details: 'some details' };
  }

  async getBalances(address: string, useTestnet = false, providerType?: string): Promise<BalanceResponse> {
    // 實現餘額查詢邏輯
    return {
      nativeBalance: {
        symbol: this.getChainSymbol(),
        decimals: 18,
        balance: '1000000000000000000'
      },
      tokens: [],
      nfts: [],
      updatedAt: Math.floor(Date.now() / 1000)
    };
  }
}
```

詳細實作請參考 [README.md](mdc:src/chains/README.md) 中的擴展指南。
